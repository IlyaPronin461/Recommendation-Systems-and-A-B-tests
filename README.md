**Добавление обработи текстовых признаков при помощи модели RoBERTa**

# Информация о данных

## Таблица user_data

Cодержит информацию о всех пользователях соц.сети

| Название поля | Описание                                                                 |
|---------------|--------------------------------------------------------------------------|
| age           | Возраст пользователя (в профиле)                        |
| city          | Город пользователя (в профиле)                               |
| country       | Страна пользователя (в профиле)                              |
| exp_group     | Экспериментальная группа: некоторая зашифрованная категория   |
| gender        | Пол пользователя                                                        |
| user_id       | Уникальный идентификатор пользователя                                   |
| os            | Операционная система устройства, с которого происходит пользование соц.сетью |
| source        | Пришел ли пользователь в приложение с органического трафика или с рекламы              |


## Таблица post_text_df

Содержит информацию о постах и уникальный ID каждой единицы с соответствующим ей текстом и топиком

| Название поля | Описание                                                                 |
|---------------|--------------------------------------------------------------------------|
| id           | Уникальный идентификатор поста                      |
| text          | Текстовое содержание поста                               |
| topic       | Основная тематика                           |


## Таблица feed_data

Содержит историю о просмотренных постах для каждого юзера в изучаемый период.

**Внимание: Таблица ООООЧЕНЬ большая. Рекомендуется не загружать ее полностью, иначе все упадет.**

| Название поля | Описание                                                                 |
|---------------|--------------------------------------------------------------------------|
| timestamp       | Время, когда был произведен просмотр                           |
| user_id           | id пользователя, который совершил просмотр                      |
| post_id          | id просмотренного поста                               |
| action       | Тип действия: просмотр или лайк                           |
| target       | 1 у просмотров, если почти сразу после просмотра был совершен лайк, иначе 0. У действий like пропущенное значение.                           |


**Пример как можно забрать из них данные:**
```
SELECT * FROM public.user_data;
SELECT * FROM public.post_text_df;
SELECT * FROM public.feed_data limit 1; --используем лимит, т.к. данных очень много
```


# Генерация признаков и создание БД

## Файл `generate_features_for_post_text_df.py`

Подключение к таблице `post_text_df`, генерация новых признаков на основе текста постов с использованием RoBERTa и загрузка в БД `ilja_pronin_gfr6897_dl_lesson10_step_5_new_post_text_df`.

**Генерируемые признаки:**
1. **Векторные представления текста (RoBERTa)**
   - Использование предобученной модели RoBERTa-base для получения эмбеддингов текста
   - Снижение размерности до 32 компонент с помощью PCA
   - Результат: колонки `pca_roberta_0` - `pca_roberta_31`

2. **Метрики текста**
   - `avg_word_length` - средняя длина слова
   - `unique_word_count` - количество уникальных слов

**Особенности реализации:**
- Пакетная обработка текстов (батчами по 32)
- Автоматическое определение устройства (GPU/CPU)
- Использование PCA для уменьшения размерности эмбеддингов
- Удаление промежуточных колонок (`word_count`, `text_length`)

---

## Файл `generate_features_for_user_data.py`

Подключение к таблице `user_data`, генерация новых признаков и загрузка в БД `ilja_pronin_gfr6897_dl_lesson10_step_5_user_data`.

**Категориальные признаки:**
1. **Возрастные группы** (бинарные):
   - `is_teenagers` (13-17 лет)
   - `is_youth` (18-35 лет)
   - `is_adults` (36-64 лет)

2. **Географические признаки**:
   - `have_million_people` - принадлежность к городу-миллионнику (15 российских городов)
   - `is_capital` - принадлежность к столице (50+ мировых столиц)
   - `is_russia` - проживание в России

3. **Технические признаки**:
   - `os` - бинаризация (Android=1, другие=0)
   - `source` - бинаризация (ads=1, organic=0)

**Агрегированные признаки:**
1. **По городам**:
   - `city_mean_age` - средний возраст жителей города
   - `city_median_age` - медианный возраст
   - `ratio_1` - распределение полов в городе (доля мужчин)

2. **Демографические метрики**:
   - `city_mean_exp_group` - средняя экспериментальная группа по стране
   - `city_popularity` - популярность города (количество пользователей)

**Особенности реализации:**
- Удаление мультиколлинеарных признаков (`ratio_0`)
- Использование словарей для быстрого маппинга значений
- Пакетная загрузка с защитой от перегрузки

# Обучение CatBoost модели

**Ссылка для скачивания модели: https://drive.google.com/file/d/1Smu7tUQnsNvSkYpHGEvRMSu3Z0y_fylA/view?usp=sharing**

**`save_model.py`** - основной скрипт для обучения и сохранения модели:
- Использует CatBoostClassifier с GPU-ускорением
- Загружает данные через `load_features_to_train.py`
- Обрабатывает категориальные признаки (конвертация в string)
- Обучает модель и сохраняет в файл `catboost_model_optimized.cbm`

**`load_features_to_train.py`** - загрузка и предобработка данных:
- Соединяет три таблицы:
  - `feed_data` (основные данные)
  - Обогащенные `user_data` (с нашими фичами)
  - Обогащенные `post_text_df` (с текстовыми фичами)
- Добавляет временные фичи:
  - `day`, `month`, `hour` - компоненты времени
  - `day_of_week` - день недели
  - `is_weekend` - признак выходного дня
  - `is_afternoon` - признак послеполуденного времени (12-18 часов)

**Ключевые параметры модели:**
- learning_rate = 0.02
- depth = 8
- iterations = 200
- l2_leaf_reg = 1
- auto_class_weights = 'Balanced'
- Размер выборки: 70к строк

# FastAPI Recommendation Service

## Файл `app.py`

Сервис для рекомендации постов с FastAPI, использующий обогащенные признаки и модель CatBoost.

### Основные компоненты:
- **FastAPI приложение** с эндпоинтом `/post/recommendations/`
- **Загрузка модели CatBoost** (предобученной)
- **Интеграция с БД** через SQLAlchemy
- **Логирование** всех операций

### Как работает:
1. Получает на вход `user_id`, дату и лимит рекомендаций
2. Объединяет признаки пользователя и постов
3. Добавляет временные признаки на основе входной даты
4. Делает предсказание вероятности лайка с помощью CatBoost
5. Фильтрует уже лайкнутые посты
6. Возвращает топ-N рекомендаций в формате:
   ```json
   {
     "id": int,
     "text": str,
     "topic": str
   }