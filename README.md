# Информация о данных

## Таблица user_data

Cодержит информацию о всех пользователях соц.сети

| Название поля | Описание                                                                 |
|---------------|--------------------------------------------------------------------------|
| age           | Возраст пользователя (в профиле)                        |
| city          | Город пользователя (в профиле)                               |
| country       | Страна пользователя (в профиле)                              |
| exp_group     | Экспериментальная группа: некоторая зашифрованная категория   |
| gender        | Пол пользователя                                                        |
| user_id       | Уникальный идентификатор пользователя                                   |
| os            | Операционная система устройства, с которого происходит пользование соц.сетью |
| source        | Пришел ли пользователь в приложение с органического трафика или с рекламы              |


## Таблица post_text_df

Содержит информацию о постах и уникальный ID каждой единицы с соответствующим ей текстом и топиком

| Название поля | Описание                                                                 |
|---------------|--------------------------------------------------------------------------|
| id           | Уникальный идентификатор поста                      |
| text          | Текстовое содержание поста                               |
| topic       | Основная тематика                           |


## Таблица feed_data

Содержит историю о просмотренных постах для каждого юзера в изучаемый период.

**Внимание: Таблица ООООЧЕНЬ большая. Рекомендуется не загружать ее полностью, иначе все упадет.**

| Название поля | Описание                                                                 |
|---------------|--------------------------------------------------------------------------|
| timestamp       | Время, когда был произведен просмотр                           |
| user_id           | id пользователя, который совершил просмотр                      |
| post_id          | id просмотренного поста                               |
| action       | Тип действия: просмотр или лайк                           |
| target       | 1 у просмотров, если почти сразу после просмотра был совершен лайк, иначе 0. У действий like пропущенное значение.                           |


**Пример как можно забрать из них данные:**
```
SELECT * FROM public.user_data;
SELECT * FROM public.post_text_df;
SELECT * FROM public.feed_data limit 1; --используем лимит, т.к. данных очень много
```


# Генерация признаков и создание БД

## Файл `generate_features_in_post_text_df.py`

Подключение к таблице `post_text_df`, генерация новых признаков на основе текста постов и загрузка в БД `ilja_pronin_gfr6897_lesson22_step_7_new_post_text_df_1`.

**Генерируемые признаки:**
1. **Кластеры текстов (KMeans)**
   - Векторизация текста с помощью TF-IDF (5000 фичей)
   - Кластеризация на 5 групп с помощью KMeans
   - Результат: колонка `cluster` с номером кластера

2. **PCA-компоненты**
   - Снижение размерности TF-IDF векторов до 2 компонент
   - Результат: колонки `pca_1` и `pca_2` с главными компонентами

3. **Метрики текста**
   - `text_length` - длина текста в символах
   - `word_count` - количество слов в тексте

**Особенности реализации:**
- Пакетная загрузка данных (чанками по 200к строк)
- Использование `TfidfVectorizer` с ограничением на 5000 фичей
- Фиксация random_state=42 для воспроизводимости

---

## Файл `generate_features_in_user_data.py`

Подключение к таблице `user_data`, генерация новых признаков и загрузка в БД `ilja_pronin_gfr6897_lesson22_step_8_user_data_1`.

**Категориальные признаки:**
1. **Возрастные группы** (бинарные):
   - `is_teenagers` (13-17 лет)
   - `is_youth` (18-35 лет)
   - `is_adults` (36-64 лет)

2. **Географические признаки**:
   - `have_million_people` - принадлежность к городу-миллионнику (15 российских городов)
   - `is_capital` - принадлежность к столице (50+ мировых столиц)
   - `is_russia` - проживание в России

3. **Технические признаки**:
   - `os` - бинаризация (Android=1, другие=0)
   - `source` - бинаризация (ads=1, organic=0)

**Агрегированные признаки:**
1. **По городам**:
   - `city_mean_age` - средний возраст жителей города
   - `city_median_age` - медианный возраст
   - `ratio_0/ratio_1` - распределение полов в городе

2. **По странам**:
   - `city_mean_exp_group` - средняя экспериментальная группа по стране

**Полиномиальные взаимодействия**:
- Генерация взаимодействий между:
  - `age`
  - `city_mean_age` 
  - `city_median_age`
- Результат:
  - `age_city_mean_age`
  - `age_city_median_age` 
  - `city_mean_age_city_median_age`

**Особенности реализации:**
- Использование `PolynomialFeatures` для взаимодействий
- Переименование колонок для читаемости
- Пакетная загрузка с защитой от перегрузки


# Обучение CatBoost модели

**Ссылка для скачивания модели: https://drive.google.com/file/d/1kgeJjspExGaxkGKfI2VIUww81Lt9p-XI/view?usp=drive_link**

**`save_model.py`** - основной скрипт для обучения и сохранения модели:
- Использует CatBoostClassifier с GPU-ускорением
- Загружает данные через `load_features_to_train.py`
- Обрабатывает категориальные признаки (конвертация в string)
- Обучает модель и сохраняет в файл `catboost_model_step_8.cbm`

**`load_features_to_train.py`** - загрузка и предобработка данных:
- Соединяет три таблицы:
  - `feed_data` (основные данные)
  - Обогащенные `user_data` (с нашими фичами)
  - Обогащенные `post_text_df` (с текстовыми фичами)
- Добавляет временные фичи из timestamp (день, месяц)
- Реализует пакетную загрузку для больших данных

**Ключевые параметры:**
- learning_rate = 0.02
- Ограничение выборки: 50к строк (для демонстрации)
- Автоматическое определение категориальных признаков

**Качество модели: HitRate@5 = 0.527**


# FastAPI Recommendation Service

## Файл `app.py`

Основной сервис для рекомендации постов с FastAPI. Ключевые функции:

### Основные компоненты:
- **FastAPI приложение** с эндпоинтом `/post/recommendations/`
- **Загрузка модели CatBoost** (предобученной)
- **Интеграция с БД** через SQLAlchemy
- **Логирование** всех операций

### Как работает:
1. Получает на вход `user_id`, дату и лимит рекомендаций
2. Обогащает данные пользователя и постов
3. Делает предсказание вероятности лайка
4. Фильтрует уже просмотренные посты
5. Возвращает топ-N рекомендаций

### Особенности:
- Автоматическая адаптация путей к модели (LMS/локально)
- Пакетная загрузка больших данных
- Обработка ошибок с логированием

**Запуск**: `uvicorn app:app --reload --port 8899`